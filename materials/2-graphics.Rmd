---
title: "Tidy Time Series & Forecasting in R"
date: "robjhyndman.com/workshop2020"
author: "2. Time series graphics"
toc: true
output:
  binb::monash:
    colortheme: monashwhite
    fig_width: 7
    fig_height: 3.5
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE,
  dev.args = list(pointsize = 11)
)
options(digits = 3, width = 60)
library(fpp3)
```

# Time plots
## Are line plots best?
\fontsize{11}{12}\sf

```{r maxtemp, fig.height=3}
maxtemp <- vic_elec %>%
  index_by(Day = date(Time)) %>%
  summarise(Temperature = max(Temperature))
maxtemp %>%
  autoplot(Temperature) +
  xlab("Week") + ylab("Max temperature")
```

## Are line plots best?
\fontsize{11}{12}\sf

```{r maxtemp2, warning=FALSE, message=FALSE, dependson="maxtemp"}
maxtemp %>%
  ggplot(aes(x = Day, y = Temperature)) +
  geom_point() +
  xlab("Week") + ylab("Max temperature")
```

## Are line plots best?
\fontsize{11}{12}\sf

```{r maxtemp3, warning=FALSE, message=FALSE, dependson="maxtemp", fig.height=2.5}
maxtemp %>%
  ggplot(aes(x = Day, y = 1)) +
  geom_tile(aes(fill = Temperature)) +
  scale_fill_gradient2(low = "navy", mid = "yellow",
                       high = "red", midpoint=28) +
  ylab("") + scale_y_discrete(expand=c(0,0))
```

## Are line plots best?

\full{TemperatureBlanket}


## Ansett airlines

\full{ansettlogo}

## Ansett airlines
\fontsize{11}{12}\sf

```{r, echo=TRUE, fig.height=3.8}
ansett %>%
  autoplot(Passengers)
```

## Ansett airlines
\fontsize{11}{12}\sf

```{r, echo=TRUE, fig.height=3.8}
ansett %>%
  filter(Class=="Economy") %>%
  autoplot(Passengers)
```

## Ansett airlines
\fontsize{11}{12}\sf

```{r, echo=TRUE, fig.height=3.8}
ansett %>%
  filter(Airports=="MEL-SYD") %>%
  autoplot(Passengers)
```

## Ansett airlines
\fontsize{11}{12}\sf

```{r, echo=TRUE, fig.height=3.8}
ansett %>%
  filter(Airports=="MEL-SYD") %>%
  autoplot(Passengers)
```

\begin{textblock}{2.2}(10,7.3)
\begin{alertblock}{}
Not the real data! Or is it?
\end{alertblock}
\end{textblock}


# Lab Session 2
## Lab Session 2

- Create time plots of the following time series: `Beer` from `aus_production`, `Lynx` from `pelt`, `Close` from `gafa_stock`
- Use `help()` to find out about the data in each series.
- For the last plot, modify the axis labels and title.

# Seasonal plots

## Seasonal plots

  * Data plotted against the individual "seasons" in which the data were observed.  (In this case a "season" is a month.)
  * Something like a time plot except that the data from each season are overlapped.
  * Enables the underlying seasonal pattern to be seen more clearly, and also allows any substantial departures from the seasonal pattern to be easily identified.
  * In R: `gg_season()`

## Quarterly Australian Beer Production
\fontsize{13}{15}\sf

```{r, fig.height=3}
beer <- aus_production %>%
  select(Quarter, Beer) %>%
  filter(year(Quarter) >= 1992)
beer %>% autoplot(Beer)
```

## Quarterly Australian Beer Production

```{r}
beer %>% gg_season(Beer, labels="right")
```

## Multiple seasonal periods
\fontsize{10}{11}\sf

```{r}
vic_elec
```

## Multiple seasonal periods
\fontsize{12}{13}\sf

```{r}
vic_elec %>% gg_season(Demand)
```

## Multiple seasonal periods
\fontsize{12}{13}\sf

```{r}
vic_elec %>% gg_season(Demand, period="week")
```

## Multiple seasonal periods
\fontsize{12}{13}\sf

```{r}
vic_elec %>% gg_season(Demand, period="day")
```

## Seasonal subseries plots

  * Data for each season collected together in time plot as separate time series.
  * Enables the underlying seasonal pattern to be seen clearly, and changes in seasonality over time to be visualized.
  * In R: `gg_subseries()`

## Quarterly Australian Beer Production

```{r}
beer %>% gg_subseries(Beer)
```

## Australian holidays
\fontsize{9}{10}\sf

```{r holidays}
holidays <- tourism %>%
  filter(Purpose=="Holiday") %>%
  group_by(State) %>%
  summarise(Trips = sum(Trips))
```

```{r, echo=FALSE}
holidays
```

## Australian holidays
\fontsize{9}{10}\sf

```{r holidays-plot, echo=TRUE, dependson="holidays", fig.height=3.9}
holidays %>% autoplot(Trips) +
  ylab("thousands of trips") + xlab("Year") +
  ggtitle("Australian domestic holiday nights")
```

## Seasonal plots
\fontsize{9}{10}\sf

```{r graphics1, fig.width=4, fig.height=5, out.width="45%"}
holidays %>% gg_season(Trips) +
  ylab("thousands of trips") +
  ggtitle("Australian domestic holiday nights")
```

## Seasonal subseries plots
\fontsize{9}{10}\sf

```{r graphics2, fig.height=4.1}
holidays %>%
  gg_subseries(Trips) + ylab("thousands of trips") +
  ggtitle("Australian domestic holiday nights")
```

## Calendar plots
\fontsize{11}{12}\sf

```{r sugrrants, eval=FALSE}
library(sugrrants)
vic_elec %>%
  filter(year(Date) == 2014) %>%
  mutate(Hour = hour(Time)) %>%
  frame_calendar(x = Hour, y = Demand, date = Date,
    nrow = 4) %>%
  ggplot(aes(x = .Hour, y = .Demand, group = Date)) +
  geom_line() -> p1
prettify(p1, size = 3,
  label.padding = unit(0.15, "lines"))
```

## Calendar plots
\fontsize{10}{11}\sf

```{r sugrrants2, echo=FALSE, fig.height=4.8, fig.width=7.5}
library(sugrrants)
vic_elec %>%
  filter(year(Date) == 2014) %>%
  mutate(Hour = hour(Time)) %>%
  frame_calendar(x = Hour, y = Demand, date = Date, nrow = 4) %>%
  ggplot(aes(x = .Hour, y = .Demand, group = Date)) +
  geom_line() -> p1
prettify(p1, size = 3, label.padding = unit(0.15, "lines"))
```

# Lab Session 3
## Lab Session 3

1. Look at the quarterly tourism data for the Snowy Mountains

    ```r
    snowy <- filter(tourism,
      Region == "Snowy Mountains")
    ```

    - Use `autoplot()`, `gg_season()` and `gg_subseries()` to explore the data.
    - What do you learn?

2. Produce a calendar plot for the `pedestrian` data from one location and one year.


# Lag plots and autocorrelation

## Example: Beer production
\fontsize{11}{12}\sf

```{r}
new_production <- aus_production %>%
  filter(year(Quarter) >= 1992)
new_production
```

## Example: Beer production
\fontsize{13}{15}\sf

```{r, fig.height=6.5, fig.width=6.5, out.width="8cm"}
new_production %>% gg_lag(Beer)
```

## Example: Beer production
\fontsize{13}{15}\sf

```{r, fig.height=6.5, fig.width=6.5, out.width="8cm"}
new_production %>% gg_lag(Beer, geom='point')
```

## Lagged scatterplots

  * Each graph shows $y_t$ plotted against $y_{t-k}$ for
different values of $k$.
  * The autocorrelations are the correlations associated
with these scatterplots.

## Autocorrelation

**Covariance** and **correlation**: measure extent of **linear relationship** between two variables ($y$ and $X$).\pause

**Autocovariance** and **autocorrelation**: measure linear relationship between **lagged values** of a time series $y$.\pause

We measure the relationship between:

  * $y_{t}$ and $y_{t-1}$
  * $y_{t}$ and $y_{t-2}$
  * $y_{t}$ and $y_{t-3}$
  * etc.

## Autocorrelation

We denote the sample autocovariance at lag $k$ by $c_k$ and the sample autocorrelation at lag $k$ by $r_k$.  Then define

\begin{block}{}
\begin{align*}
c_k &= \frac{1}{T}\sum_{t=k+1}^T (y_t-\bar{y})(y_{t-k}-\bar{y}) \\[0.cm]
\text{and}\qquad
r_{k} &= c_k/c_0
\end{align*}
\end{block}\pause\small

  * $r_1$ indicates how successive values of  $y$  relate to each other
  * $r_2$ indicates how  $y$ values two periods apart relate to each other
  * $r_k$ is \textit{almost} the same as the sample correlation between $y_t$ and $y_{t-k}$.

## Autocorrelation


Results for first 9 lags for beer data:

\fontsize{11}{13}\sf

```{r, echo=TRUE}
new_production %>% ACF(Beer, lag_max = 9)
```

## Autocorrelation

Results for first 9 lags for beer data:

\fontsize{11}{13}\sf

```{r beeracf, fig.height=2.5}
new_production %>% ACF(Beer, lag_max = 9) %>% autoplot()
```

\vspace*{10cm}

## Autocorrelation

  * $r_{4}$  higher than for the other lags. This is due to **the seasonal pattern in the data**: the peaks tend to be **4 quarters** apart and the troughs tend to be **2 quarters** apart.
  * $r_2$ is more negative than for the other lags because troughs tend to be 2 quarters behind peaks.
  * Together, the autocorrelations at lags 1, 2, \dots, make up the \emph{autocorrelation} or ACF.
  * The plot is known as a **correlogram**

## ACF

```{r, fig.height=4, echo=TRUE}
new_production %>% ACF(Beer) %>% autoplot()
```

## Australian holidays
\fontsize{9}{10}\sf

```{r tourismacf}
holidays %>% ACF(Trips)
```

## Australian holidays
\fontsize{9}{10}\sf

```{r tourismacf2, fig.height=6}
holidays %>% ACF(Trips) %>% autoplot()
```


## Trend and seasonality in ACF plots

- When data have a trend, the autocorrelations for small lags tend to be large and positive.
- When data are seasonal, the autocorrelations will be larger at the seasonal lags (i.e., at multiples of the seasonal frequency)
- When data are trended and seasonal, you see a combination of these effects.

## Aus monthly electricity production

```{r}
elec2 <- as_tsibble(fma::elec) %>%
  filter(year(index) >= 1980)
elec2 %>% autoplot(value)
```

## Aus monthly electricity production

```{r}
elec2 %>% ACF(value, lag_max=48) %>%
  autoplot()
```

## Aus monthly electricity production

Time plot shows clear trend and seasonality.

The same features are reflected in the ACF.

  * The slowly decaying ACF indicates trend.
  * The ACF peaks at lags 12, 24, 36, \dots, indicate seasonality of length 12.

## Google stock price
\fontsize{12}{14}\sf

```{r google-2015}
google_2015 <- gafa_stock %>%
  filter(Symbol == "GOOG", year(Date) == 2015) %>%
  select(Date, Close)
google_2015
```

## Google stock price

```{r}
google_2015 %>% autoplot(Close)
```

## Google stock price
\fontsize{12}{16}\sf

```r
google_2015 %>%
  ACF(Close, lag_max=100)
# Error: Can't handle tsibble of irregular interval.
```

\pause

```{r}
google_2015
```

## Google stock price
\fontsize{12}{14}\sf

```{r}
google_2015 <- google_2015 %>%
  mutate(trading_day = row_number()) %>%
  update_tsibble(index=trading_day, regular=TRUE)
google_2015
```

## Google stock price

```{r}
google_2015 %>%
  ACF(Close, lag_max=100) %>%
  autoplot()
```

# Lab Session 4

## Lab Session 4

We have introduced the following functions:

  - `gg_lag`
  - `ACF`

Explore the following time series using these functions. Can you spot any seasonality, cyclicity and trend? What do you learn about the series?

  - Bricks from `aus_production`
  - Lynx from `pelt`
  - Victorian Electricity Demand from `aus_elec`

## Which is which?

```{r, fig.height=6, fig.width=12, echo=FALSE, warning=FALSE, out.width="11.5cm"}
cowtemp <- as_tsibble(fma::cowtemp)
USAccDeaths <- as_tsibble(USAccDeaths)
AirPassengers <- as_tsibble(AirPassengers)
mink <- as_tsibble(fma::mink)
tp1 <- autoplot(cowtemp, value) + xlab("") + ylab("chirps per minute") +
  ggtitle("1. Daily temperature of cow")
tp2 <- autoplot(USAccDeaths, value) + xlab("") + ylab("thousands") +
  ggtitle("2. Monthly accidental deaths")
tp3 <- autoplot(AirPassengers, value) + xlab("") + ylab("thousands") +
  ggtitle("3. Monthly air passengers")
tp4 <- autoplot(mink, value) + xlab("") + ylab("thousands") +
  ggtitle("4. Annual mink trappings")
acfb <- ACF(cowtemp, value) %>% autoplot() + xlab("") + ggtitle("B") + ylim(-0.4,1)
acfa <- ACF(USAccDeaths, value) %>% autoplot() + xlab("") + ggtitle("A") + ylim(-0.4,1)
acfd <- ACF(AirPassengers, value) %>% autoplot() + xlab("") + ggtitle("D") + ylim(-0.4,1)
acfc <- ACF(mink, value) %>% autoplot() + xlab("") + ggtitle("C") + ylim(-0.4,1)
gridExtra::grid.arrange(tp1,tp2,tp3,tp4,
                        acfa,acfb,acfc,acfd,nrow=2)
```

# White noise

## Example: White noise
\fontsize{13}{15}\sf

```{r}
wn <- tsibble(t = seq_len(36), y = rnorm(36),
              index = t)
wn %>% autoplot(y)
```

## Example: White noise
\fontsize{10}{15}\sf\tabcolsep=0.1cm

```{r, echo=FALSE}
wn %>% ACF(y, lag_max = 10) %>%
  as_tibble() %>%
  tidyr::spread(lag, acf) %>%
  rename_all(function(x){paste("$r_{",x,"}$",sep="")}) %>%
  knitr::kable(booktabs=TRUE,
               escape=FALSE, align="c", digits=3,
               format.args=list(nsmall=3))
```

```{r, echo=FALSE}
wn %>% ACF(y) %>% autoplot()
```

## \large Sampling distribution of autocorrelations

Sampling distribution of $r_k$ for white noise data is asymptotically N(0,$1/T$).\pause

  *  95% of all $r_k$ for white noise must lie within $\pm 1.96/\sqrt{T}$.
  * If this is not the case, the series is probably not WN.
  * Common to plot lines at $\pm 1.96/\sqrt{T}$ when plotting ACF.
These are the \alert{critical values}.

## Example: Pigs slaughtered

\fontsize{12}{13}\sf

```{r, fig.height=3}
pigs <- aus_livestock %>%
  filter(State == "Victoria", Animal == "Pigs",
         year(Month) >= 2014)
pigs %>% autoplot(Count/1e3) +
  xlab("Year") + ylab("Thousands") +
  ggtitle("Number of pigs slaughtered in Victoria")
```

## Example: Pigs slaughtered

```{r}
pigs %>% ACF(Count) %>% autoplot()
```

## Example: Pigs slaughtered

Monthly total number of pigs slaughtered
in the state of Victoria, Australia, from January 2014 through December 2018
(Source: Australian Bureau of Statistics.)\pause

  * Difficult to detect pattern in time plot.
  * ACF shows significant autocorrelation for lag 2 and 12.
  * Indicate some slight seasonality.

\pause

These show the series is **not a white noise series**.

# Lab Session 5
## Lab Session 5


You can compute the daily changes in the Google stock price in 2018 using

\fontsize{11.5}{15}\sf


```{r, eval = FALSE}
dgoog <- gafa_stock %>%
  filter(Symbol == "GOOG", year(Date) >= 2018) %>%
  mutate(trading_day = row_number()) %>%
  update_tsibble(index=trading_day, regular=TRUE) %>%
  mutate(diff = difference(Close))
```

\fontsize{14}{16}\sf

Does `diff` look like white noise?
